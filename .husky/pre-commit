# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸš¨ EMERGENCY STOP: --no-verify GONORRHEA DETECTOR (RUNS FIRST)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
.husky/no-verify-detector || exit 1

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ›¡ï¸ VRP PURITY CHECK: Unstaged Files Detector
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
.husky/unstaged-detector || exit 1

# VRP Enforcement - Zero tolerance for violations
echo "ğŸ” VRP Pre-Commit Checks..."

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ›¡ï¸ WCCC PROTECTION - Block page-specific CSS files
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if git diff --cached --name-only | grep -E 'src/app/.*/page\.css$'; then
  echo ""
  echo "â›” WCCC VIOLATION: page.css files are not allowed!"
  echo ""
  echo "Page-specific CSS files violate the 5-hub architecture."
  echo ""
  echo "Allowed CSS hubs:"
  echo "  â€¢ /styles/vr.css (vr-* components)"
  echo "  â€¢ /styles/features.css (ft-* components)"
  echo "  â€¢ /styles/layout.css (ly-* shell + layouts)"
  echo ""
  echo "If you need custom styling:"
  echo "  1. Check if a prebuilt variant exists"
  echo "  2. Create new prebuilt variant in /src/vr/"
  echo "  3. Last resort: Create feature component in /src/features/"
  echo ""
  echo "See TTT-WCCC-PROTOCOL.md for architectural rationale."
  echo ""
  echo "Commit blocked."
  exit 1
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ”’ SACRED CONFIG PROTECTION - Approval Bridge for protected files
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Protected files: eslint.config.mjs, .stylelintrc.json, package.json, .husky/*
PROTECTED_FILES="eslint.config.mjs|\.stylelintrc\.json|package\.json|\.husky/"

if git diff --cached --name-only | grep -qE "^($PROTECTED_FILES)"; then
  # Get the specific file(s) being modified
  MODIFIED_PROTECTED=$(git diff --cached --name-only | grep -E "^($PROTECTED_FILES)")

  # Check for approval token
  if [ -f ".vrp-approval" ]; then
    echo "âœ… Approval token found - Protected file change authorized"
    echo "   Files: $MODIFIED_PROTECTED"
    rm -f .vrp-approval  # Consume token (single-use)
    echo "ğŸ”¥ Token consumed (single-use)"
  else
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  ğŸ›‘ STOP! YOU ARE WASTING YOUR TIME!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  Modified: $MODIFIED_PROTECTED"
    echo ""
    echo "  Even if you bypass this hook, GitHub will BLOCK your push."
    echo "  These files are protected by CODEOWNERS - only @Metafoorm"
    echo "  can approve changes. There is NO backdoor. NO bypass."
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  ğŸš« --no-verify IS USELESS"
    echo "  Go ahead, try it. GitHub will still reject your push."
    echo "  Server-side enforcement. No local bypass possible."
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  LEGITIMATE WORKFLOW:"
    echo "    1. Create a feature branch"
    echo "    2. Make your changes"
    echo "    3. Create a Pull Request"
    echo "    4. Wait for @Metafoorm approval"
    echo ""
    echo "  Commit blocked. Don't waste your time."
    echo ""
    exit 1
  fi
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“ GLOBAL FILE SIZE GATE - Prevent code bloat (400 lines default)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# See: .husky/CODE-SIZE-POLICY.md
# Default: 400 lines | Exceptions require in-file justification
DEFAULT_LIMIT=400

# Exception list: path=limit (explicit allowlist per policy)
# These are acknowledged architectural debt - not permanent privileges
get_file_limit() {
  case "$1" in
    # Schema/Store (inherently large, single source of truth)
    "convex/schema.ts") echo 1200 ;;
    "src/store/fuse.ts") echo 1400 ;;
    # Email sync orchestrator (complex state machine)
    "convex/productivity/email/outlook.ts") echo 1200 ;;
    "convex/productivity/email/webhooks.ts") echo 800 ;;
    "src/features/productivity/email-console/index.tsx") echo 1300 ;;
    # Admin APIs (complex domain logic)
    "convex/domains/admin/users/api.ts") echo 1000 ;;
    "convex/admin/dbCleanup.ts") echo 700 ;;
    "convex/domains/productivity/mutations.ts") echo 700 ;;
    "convex/domains/productivity/queries.ts") echo 600 ;;
    # Setup/Shell (multi-step flows)
    "src/features/setup/setup-modal/index.tsx") echo 800 ;;
    "src/features/shell/user-button/index.tsx") echo 700 ;;
    "src/features/shell/company-button/index.tsx") echo 600 ;;
    # Vanish cascade (transactional integrity)
    "convex/vanish/cascade.ts") echo 600 ;;
    # Email module files (recently refactored, 600 transition)
    # Transitional caps during inbox canonicalisation - expected to decompose post-stabilisation
    "convex/productivity/email/outlookStore.ts") echo 600 ;;
    "convex/productivity/email/outlookDiagnostics.ts") echo 700 ;;
    "convex/productivity/email/outlookActions.ts") echo 600 ;;
    "convex/productivity/email/bodyCache.ts") echo 600 ;;
    # Feature tabs (complex UI, 600 transition)
    "src/features/settings/account-page/_tabs/EmailTab.tsx") echo 600 ;;
    "src/features/admin/showcase-page/_tabs/FtGuideTab.tsx") echo 600 ;;
    "src/features/admin/showcase-page/_tabs/TypographyTab.tsx") echo 600 ;;
    "src/features/admin/users-page/_tabs/InvitesTab.tsx") echo 600 ;;
    "src/features/vanish/VanishQuarantine.tsx") echo 600 ;;
    # Clerk actions (auth complexity)
    "src/app/(clerk)/actions/email.ts") echo 600 ;;
    "src/app/(clerk)/features/VerifySecondary/index.tsx") echo 600 ;;
    "src/app/actions/user-mutations.ts") echo 600 ;;
    # Mock data (not real code)
    "src/features/productivity/email2-console/mockData.ts") echo 1000 ;;
    # Default
    *) echo $DEFAULT_LIMIT ;;
  esac
}

# Check all staged .ts and .tsx files
for file in $(git diff --cached --name-only | grep -E '\.(ts|tsx)$'); do
  if [ -f "$file" ]; then
    lines=$(wc -l < "$file" | tr -d ' ')
    limit=$(get_file_limit "$file")

    if [ "$lines" -gt "$limit" ]; then
      echo ""
      echo "â›” FILE SIZE VIOLATION: $file"
      echo ""
      echo "   Current: $lines lines"
      echo "   Limit:   $limit lines"
      echo ""
      if [ "$limit" -eq "$DEFAULT_LIMIT" ]; then
        echo "   This file exceeds the 400-line default limit."
        echo "   Options:"
        echo "     1. Split into smaller, focused modules"
        echo "     2. Request exception (requires in-file justification)"
        echo ""
        echo "   See: .husky/CODE-SIZE-POLICY.md"
      else
        echo "   This file exceeds its exception limit."
        echo "   The exception exists for a reason - don't exceed it."
        echo "   Consider splitting or refactoring."
      fi
      echo ""
      echo "   Commit blocked."
      exit 1
    fi
  fi
done

# Run critical VRP scripts (manifest validation skipped - legacy routes not yet in SRS manifests)
npm run vrp:isv || exit 1
npm run vrp:naming || exit 1
npm run vrp:css || exit 1
npm run vrp:class-scan || exit 1
npm run vrp:typography || exit 1

# Run lint-staged for TypeScript/ESLint checks
npx lint-staged
