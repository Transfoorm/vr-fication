#!/bin/sh
# 🚨 EMERGENCY STOP: --no-verify GONORRHEA DETECTOR
# Triggers nuclear response when --no-verify infection is detected

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo ""
echo "${RED}═══════════════════════════════════════════════════════════════${NC}"
echo "${RED}  🚨 SCANNING FOR --no-verify GONORRHEA...${NC}"
echo "${RED}═══════════════════════════════════════════════════════════════${NC}"
echo ""

# Check staged files for --no-verify infection
# Exempt:
#   - .claude/commands/*.md documentation files (they document the prohibition)
#   - .husky/no-verify-detector (the hook itself)
#   - .husky/pre-commit (contains comment header about the detector)
#   - CLAUDE.md (project documentation about the prohibition)
#   - _sdk/09-protocols/*.md (SDK protocol documentation - old path)
#   - .sdk/09-protocols/*.md (SDK protocol documentation - new path)
#   - scripts/checkISV.ts (validation script showing error examples)
#   - scripts/checkNaming.ts (validation script showing error examples)
INFECTED_FILES=$(git diff --cached --name-only | grep -vE "^(\.claude/commands/.*\.md|\.husky/no-verify-detector|\.husky/pre-commit|CLAUDE\.md|_sdk/09-protocols/.*\.md|\.sdk/09-protocols/.*\.md|scripts/checkISV\.ts|scripts/checkNaming\.ts|Independant-Report-Review\.md|Independent-Technical-Appraisal-Directive\.md)$" | xargs grep -l "\-\-no-verify" 2>/dev/null || true)

if [ -n "$INFECTED_FILES" ]; then
  echo ""
  echo "${RED}╔═══════════════════════════════════════════════════════════════╗${NC}"
  echo "${RED}║                                                               ║${NC}"
  echo "${RED}║              ☢️  NUCLEAR ALERT ☢️                              ║${NC}"
  echo "${RED}║                                                               ║${NC}"
  echo "${RED}║         --NO-VERIFY GONORRHEA DETECTED!                       ║${NC}"
  echo "${RED}║                                                               ║${NC}"
  echo "${RED}╚═══════════════════════════════════════════════════════════════╝${NC}"
  echo ""
  echo "${YELLOW}INFECTED FILES:${NC}"
  echo "$INFECTED_FILES" | while read -r file; do
    echo "  💣 $file"
    echo ""
    echo "${YELLOW}INFECTION DETAILS:${NC}"
    grep -n "\-\-no-verify" "$file" | head -5 | while read -r line; do
      echo "     $line"
    done
    echo ""
  done
  echo ""
  echo "${RED}═══════════════════════════════════════════════════════════════${NC}"
  echo "${RED}  ⛔ THIS IS NOT A DRILL${NC}"
  echo "${RED}═══════════════════════════════════════════════════════════════${NC}"
  echo ""
  echo "${YELLOW}You attempted to commit code containing '--no-verify'.${NC}"
  echo ""
  echo "${YELLOW}This is the bypass mechanism that DESTROYS repository purity.${NC}"
  echo "${YELLOW}This is the infection that makes all protections WORTHLESS.${NC}"
  echo "${YELLOW}This is the gonorrhea of version control.${NC}"
  echo ""
  echo "${RED}COMMIT REJECTED.${NC}"
  echo ""
  echo "${YELLOW}Remove ALL instances of '--no-verify' from your code.${NC}"
  echo "${YELLOW}There is NO legitimate use case for bypassing hooks.${NC}"
  echo "${YELLOW}If a hook blocks you, FIX THE VIOLATION, don't bypass it.${NC}"
  echo ""
  echo "${RED}═══════════════════════════════════════════════════════════════${NC}"
  echo ""
  exit 1
fi

# Check commit message for --no-verify infection
COMMIT_MSG_FILE="$1"
if [ -n "$COMMIT_MSG_FILE" ] && grep -q "\-\-no-verify" "$COMMIT_MSG_FILE" 2>/dev/null; then
  echo ""
  echo "${RED}╔═══════════════════════════════════════════════════════════════╗${NC}"
  echo "${RED}║                                                               ║${NC}"
  echo "${RED}║              ☢️  NUCLEAR ALERT ☢️                              ║${NC}"
  echo "${RED}║                                                               ║${NC}"
  echo "${RED}║    --NO-VERIFY DETECTED IN COMMIT MESSAGE!                    ║${NC}"
  echo "${RED}║                                                               ║${NC}"
  echo "${RED}╚═══════════════════════════════════════════════════════════════╝${NC}"
  echo ""
  echo "${YELLOW}Your commit message contains the phrase '--no-verify'.${NC}"
  echo ""
  echo "${YELLOW}Even MENTIONING this bypass is a red flag.${NC}"
  echo "${YELLOW}Don't document it. Don't suggest it. Don't think about it.${NC}"
  echo ""
  echo "${RED}COMMIT REJECTED.${NC}"
  echo ""
  exit 1
fi

echo "${YELLOW}✅ No --no-verify infection detected${NC}"
echo ""
